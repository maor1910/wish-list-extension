var currentUrl,previousUrl,postReferral,testing=!1,prodUrl="https://extensions.adjusti.co/",testUrl="http://localhost:3000/",postDomain=testing?testUrl:prodUrl,keywordRoute="addSponsoredProductsAndBrandByKeyword",productRoute="product",currentAndPreviousTab=[],reload={flag:!1,timer:null,length:3e3},newTab={flag:!1,timer:null,length:10},posting={flag:!1,queue:[]};function isDefinedAndNotEmpty(e){return null!=e&&""!=e}function extractSubstringFromString(e,t,n){var r=e,i=t.length,o=r.indexOf(t)+i;return r=r.substring(o),n.forEach(function(e){if(r.indexOf(e)>0){var t=r.indexOf(e);r=r.substring(0,t)}}),r}function isRelevantAmazonUrl(e){return!!isDefinedAndNotEmpty(e)&&(e.includes("https://www.amazon.")&&(e.includes("/dp/")||e.includes("/gp/")||e.includes("/s/")||e.includes("s?k=")||e.includes("s&k=")))}function shortenUrl(e){return e.length>250?e.substring(0,248):e}function specifyAmazonUrls(e){var t,n;if(isDefinedAndNotEmpty(e))return e.includes("/dp/")?e.includes(".com/dp/")?(t=extractSubstringFromString(e,".com/dp/",["/","?"])).includes("%20")?t.replace(/(\%20)/g," "):t:(t=extractSubstringFromString(e,"/dp/",["/","?"])).includes("%20")?t.replace(/(\%20)/g," "):t:e.includes("/gp/")&&e.includes("dp%2F")?extractSubstringFromString(e,"dp%2F",["%2F"]):e.includes("field-keywords=")?(n=extractSubstringFromString(e,"field-keywords=",["&","?"])).replace(/(\+|\%20)/g," "):e.includes("keywords%3D")||e.includes("dp%2F")?e.includes("keywords%3D")?(n=extractSubstringFromString(e,"keywords%3D",["psc","qid"])).includes("%26")?n.replace("%26"," ").trim():n:e.includes("dp%2F")?extractSubstringFromString(e,"dp%2F",["%2"]):void 0:e.includes("k=")?(n=extractSubstringFromString(e,"k=",["&","?"])).replace(/(\+|\%20)/g," "):shortenUrl(e)}function initializeBuffer(e){e.flag=!0,e.timer=setTimeout(function(){e.flag=!1},e.length)}function getLocationFromAPI(){return new Promise(function(e){fetch("https://ipinfo.io/json").then(function(e){return e.json()}).then(function(t){var n={};isDefinedAndNotEmpty(t.country)&&(n.country=t.country),isDefinedAndNotEmpty(t.city)&&(n.city=t.city),isDefinedAndNotEmpty(t.region)&&!n.city&&(n.city=t.region),isDefinedAndNotEmpty(t.ip)&&(n.IP=t.ip),n.time=Date.now(),e(n)})})}function getLocationFromStorage(){return new Promise(function(e){chrome.storage.local.get(null,function(t){e(t.location)})})}function getPhysicalLocation(){return new Promise(function(e){getLocationFromStorage().then(function(t){isDefinedAndNotEmpty(t)&&t.lastChecked&&Date.now()-t.lastChecked<432e5?e(t):getLocationFromAPI().then(function(t){var n=Date.now(),r={country:t.country,city:t.city,IP:t.IP,lastChecked:n};chrome.storage.local.set({location:r},function(){}),e(r)})})})}function addTabId(e){2==currentAndPreviousTab.length?(currentAndPreviousTab.shift(),currentAndPreviousTab.push(e)):currentAndPreviousTab.length<2&&currentAndPreviousTab.push(e)}function addPostToQueue(e,t){getPhysicalLocation().then(function(t){var n=t.IP,r=t.country,i=t.city;t.region;return e.IP=n,e.country=r,e.city=i,isDefinedAndNotEmpty(e.referral)?(e.referral=isRelevantAmazonUrl(e.referral)?specifyAmazonUrls(e.referral):shortenUrl(e.referral),e):(isDefinedAndNotEmpty(postReferral)&&(e.keyword&&e.keyword!=postReferral||e.asin&&e.asin!=postReferral)&&(e.referral=postReferral),e)}).then(function(e){postData(e,t)})}function postData(e,t){return new Promise(function(n){1==testing&&console.log("POSTING ",e),fetch(t,{method:"post",headers:{"Content-type":"application/json;charset=UTF-8"},body:JSON.stringify(e)}).then(function(e){return e.text()}).then(function(e){n(e)}).catch(function(e){console.log(e),n(e)})})}getPhysicalLocation(),chrome.tabs.onActivated.addListener(function(e){isDefinedAndNotEmpty(e)&&isDefinedAndNotEmpty(e.tabId)&&(initializeBuffer(newTab),addTabId(e.tabId))}),chrome.webNavigation.onCompleted.addListener(function(e){var t=e.url;isDefinedAndNotEmpty(t)&&isRelevantAmazonUrl(t)&&chrome.tabs.sendMessage(e.tabId,{background:"transitionCrawl"},function(){})}),chrome.webNavigation.onBeforeNavigate.addListener(function(e){var t=isRelevantAmazonUrl(e.url)?specifyAmazonUrls(e.url):shortenUrl(e.url);if(newTab.flag&&isDefinedAndNotEmpty(currentAndPreviousTab[currentAndPreviousTab.length-1])){var n=currentAndPreviousTab[currentAndPreviousTab-1];chrome.tabs.get(n,function(e){isDefinedAndNotEmpty(e)&&isDefinedAndNotEmpty(e.url)&&(previousUrl=isRelevantAmazonUrl(e.url)?specifyAmazonUrls(e.url):e.url,postReferal=t!=previousUrl?previousUrl:"")})}else e&&e.tabId&&isDefinedAndNotEmpty(e.parentFrameId)&&-1===e.parentFrameId&&isDefinedAndNotEmpty(e.url)&&!newTab.flag&&(currentUrl!=t?(previousUrl=currentUrl,currentUrl=t,postReferral=previousUrl):postReferral="")}),chrome.webNavigation.onCommitted.addListener(function(e){if(e&&isDefinedAndNotEmpty(e.tabId)){var t=isRelevantAmazonUrl(e.url)?specifyAmazonUrls(e.url):shortenUrl(e.url);if("reload"==e.transitionType)return void initializeBuffer(reload);chrome.tabs.get(e.tabId,function(e){e.active}),e&&isDefinedAndNotEmpty(e.url)&&isRelevantAmazonUrl(e.url)&&t.startsWith("https")}}),chrome.runtime.onMessage.addListener(function(e,t,n){e.keyword?addPostToQueue(e,postDomain+keywordRoute):e.asin?addPostToQueue(e,postDomain+productRoute):"loaded"==e.content&&(reload.flag||n("initialize"))});