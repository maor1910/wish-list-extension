var selectors={addToCartButton:"#add-to-cart-button",addToListButton:"#add-to-wishlist-button-submit",searchPage:{url:"/s/",intlUrl:"/s?k=",keyword:"twotabsearchtextbox",productsWrapper:"ul#s-results-list-atf",products:"li[id^='result_']",altProducts:"div.s-result-list",isSponsored:"div>h5.s-sponsored-header",isSponsoredCn:"span.a-size-base.a-color-secondary",sponsoredClass:"AdHolder",sponsoredProducts:{productName:["div > div > div > div.a-fixed-left-grid-col.a-col-right div > div > a > h2[data-attribute]","div > div.a-row.a-spacing-none.s-color-subdued > div > a > h2[data-attribute]","div > div.a-row.a-spacing-none > div > a > h2[data-attribute]","div > a.a-link-normal > h2[data-attribute]"],altProductName:["a>span.a-size-base-plus.a-color-base.a-text-normal"],price:["span.sx-price-large","a>span.a-offscreen","span.a-size-base.a-color-price.s-price.a-text-bold","span.a-size-base.a-color-base.s-size-mild","span>span.a-offscreen"],brand:["span.a-color-base.s-overflow-ellipsis.a-size-base.a-text-bold","span.a-color-secondary.s-overflow-ellipsis.s-size-mild","div:last-child.a-row.a-spacing-none","span.a-row.a-size-base.a-color-secondary","div.a-row.a-size-base.a-color-secondary>span"],brandimage:["div>div>div>img"],rate:["i.a-icon-star>span.a-icon-alt","i.a-icon>span.a-icon-alt"],ratings:["a.a-link-normal>span.a-size-base","div.a-row.a-spacing-mini > a.a-size-small.a-link-normal.a-text-normal","div.a-row.a-spacing-none> a.a-size-small.a-link-normal.a-text-normal"],image:["img.s-access-image","img.s-image"],coupon:["i.a-icon.a-icon-addon.a-align-bottom.sx-bestseller-badge-primary"]},sponsoredBrand:{brandName:"hsaSponsoredByBrandName",adImage:".mediaCentralImage.imageContainer__image",headline:"pdagDesktopSparkleHeadline",products:{blockElement:"#pdagDesktopSparkleAsinsContainer",asin:["div>div.asinImage"],image:[".mediaCentralImage .imageContainer__image"]}}},productPage:{url:"/dp/",ASIN:"#ftSelectAsin",brandName:"bylineInfo",brandNameAlt:"a#brand",coupon:"clickableVpcButton-announce",mainImage:"landingImage",comparisonImage:"comparison_image",numOfRates:"[data-hook='total-review-count']",rate:"[data-hook='rating-out-of-text']",price:"#priceblock_ourprice",priceAlt:"#unqualified > div > span.a-color-price",priceDeal:"#priceblock_dealprice",priceSale:"#priceblock_saleprice",productName:"span#productTitle",relatedSponsored:{detailOne:"#sp_detail",detailTwo:"#sp_detail2",carousel:"ol.a-carousel",product:{asin:["[data-asin]"],image:["img.a-dynamic-image"]}}},attributes:{dataAsin:"data-asin",dataAttribute:"data-attribute",src:"src",id:"id",dataIndex:"data-index",title:"title",alt:"alt",href:"href",dataADynamicImage:"data-a-dynamic-image"}},byStrings=["by","von","di","de","por","door"],marketplaces=[{url:".com/",shortcut:"US"},{url:".ca/",shortcut:"CA"},{url:".de/",shortcut:"DE"},{url:".fr/",shortcut:"FR"},{url:".in/",shortcut:"IN"},{url:".it/",shortcut:"IT"},{url:".co.jp/",shortcut:"JP"},{url:".com.mx/",shortcut:"MX"},{url:".es/",shortcut:"ES"},{url:".co.uk/",shortcut:"UK"}],crawling={flag:!1,timer:null,length:3e3},crawled={flag:!1,timer:null,length:900},searchTransition={flag:!1,timer:null,length:120},currentUrl=window.location.href;function isSpaMarketplace(e){return"UK"==e||"ES"==e||"IT"==e}function isSearchPage(e){return e.toString().includes(selectors.searchPage.url)||e.toString().includes(selectors.searchPage.intlUrl)}function asyncDelay(e){return new Promise(t=>setTimeout(t,e))}function initializeBuffer(e){e.flag=!0,e.timer=setTimeout(function(){e.flag=!1},e.length)}function sendToBackground(e){chrome.runtime.sendMessage(e,function(){})}function removeArrayDupes(e,t){return e.filter(function(e,r,a){return a.map(function(e){return e[t]}).indexOf(e[t])===r})}function isDefinedAndNotEmpty(e){return null!=e&&""!=e}function elementHasTextValue(e){return e&&e.length&&e.length>0&&(e=e[0]),e&&isDefinedAndNotEmpty(e.innerText)?e.innerText:!(!e||!isDefinedAndNotEmpty(e.textContent))&&e.textContent}function translateSpecialCharacters(e){return e.replace(/&quot;/g,'"').replace(/&rsquo;/g,"”").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&OElig;/g,"Œ").replace(/&oelig;/g,"œ").replace(/&Scaron;/g,"Š").replace(/&scaron;/g,"š").replace(/&Yuml;/g,"Ÿ").replace(/&circ;/g,"ˆ").replace(/&tilde;/g,"˜").replace(/&ndash;/g,"–").replace(/&mdash;/g,"—").replace(/&lsquo;/g,"‘").replace(/&rsquo;/g,"’").replace(/&sbquo;/g,"‚").replace(/&ldquo;/g,"“").replace(/&bdquo;/g,"„").replace(/&dagger;/g,"†").replace(/&Dagger;/g,"‡").replace(/&permil;/g,"‰").replace(/&lsaquo;/g,"‹").replace(/&rsaquo;/g,"›").replace(/&euro;/g,"€").replace(/&copy;/g,"©").replace(/&trade;/g,"™").replace(/&reg;/g,"®").replace(/&#39;/g,"'")}function getElementFromSelectorStrings(e,t){if(t&&t.length>0)for(i=0;i<=t.length;i++)if(e.querySelector(t[i]))return e.querySelector(t[i]);return!1}function getDataFromAttributeOrText(e,t){return t.attribute?elementHasAttributeValue(e,t.attribute):elementHasTextValue(e)}function getValidElementContent(e,t){var r=t.elementSelector;if(r&&r.length>0){for(i=0;i<=r.length;i++)if(e.querySelector(r[i])){var a=e.querySelector(r[i]);if(getAndValidateData(a,t))return getAndValidateData(a,t)}}else if(getAndValidateData(e,t))return getAndValidateData(e,t)}function getAndValidateData(e,t){if(getDataFromAttributeOrText(e,t)){var r=getDataFromAttributeOrText(e,t);if(shapeAndValidateData(r,t))return shapeAndValidateData(r,t)}}function getMarketplace(e){for(i=0;i<marketplaces.length;i++)if(e.includes(marketplaces[i].url))return marketplaces[i].shortcut}function extractSubstringFromString(e,t,r){var a=e,n=t.length,s=a.indexOf(t)+n;return a=a.substring(s),r.forEach(function(e){if(a.indexOf(e)>0){var t=a.indexOf(e);a=a.substring(0,t)}}),a}function elementHasAttributeValue(e,t){return!!(e&&e.hasAttribute(t)&&isDefinedAndNotEmpty(e.getAttribute(t)))&&e.getAttribute(t)}function shapeAndValidateData(e,t){if(e)return t.dataShape&&(e=t.dataShape(e)),t.validate?t.validate(e)?t.validate(e):"":e}function isNumber(e){return!isNaN(Number(e))}function endsWithYear(e){return!!e.match(/[20|19]\d{2}$/g)}function startsWithBy(e){return byStrings.forEach(function(t){if(e.startsWith(t))return t}),!1}function getProductByVars(e,t){var r={};return e.forEach(function(e){var a=getValidElementContent(t,e);a||(a=e.nonValue?e.nonValue:""),r[e.name]=a}),r}window.addEventListener("keypress",async function(e){if("Enter"==event.key){await asyncDelay(100);var t=window.location.href,r=getMarketplace(currentUrl);t!=currentUrl&&isSpaMarketplace(r)&&isSearchPage(t)&&isSearchPage(currentUrl)&&!searchTransition.flag&&(initializeBuffer(searchTransition),await asyncDelay(1100),crawling.flag||crawled.flag||(initializeBuffer(crawling),crawlDOM(currentUrl))),searchTransition.flag||(currentUrl=t)}}),window.addEventListener("click",async function(e){await asyncDelay(100);var t=window.location.href,r=getMarketplace(currentUrl);t!=currentUrl&&isSpaMarketplace(r)&&isSearchPage(t)&&isSearchPage(currentUrl)&&!searchTransition.flag&&(initializeBuffer(searchTransition),await asyncDelay(1100),crawling.flag||crawled.flag||(initializeBuffer(crawling),crawlDOM(currentUrl))),searchTransition.flag||(currentUrl=t)});var relatedProductVars=[{name:"asin",elementSelector:selectors.productPage.relatedSponsored.product.asin,attribute:selectors.attributes.dataAsin,validate:function(e){return e.startsWith("B")?e:""}},{name:"image",elementSelector:selectors.productPage.relatedSponsored.product.image,attribute:selectors.attributes.src},{name:"name",elementSelector:selectors.productPage.relatedSponsored.product.image,attribute:selectors.attributes.alt,dataShape:function(e){return translateSpecialCharacters(e)}}],sponsoredBrandProductVars=[{name:"asin",elementSelector:selectors.searchPage.sponsoredBrand.products.asin,attribute:selectors.attributes.dataAsin,validate:function(e){return e.startsWith("B")?e:""}},{name:"image",elementSelector:selectors.searchPage.sponsoredBrand.products.image,attribute:selectors.attributes.src},{name:"name",elementSelector:selectors.searchPage.sponsoredBrand.products.image,attribute:selectors.attributes.title}],sponsoredProductVars=[{name:"asin",attribute:selectors.attributes.dataAsin,validate:function(e){return e.startsWith("B")?e:""}},{name:"brand",elementSelector:selectors.searchPage.sponsoredProducts.brand,validate:function(e){for(var t=0;t<byStrings.length;t++)if(e.startsWith(byStrings[t]))return e.substring(byStrings[t].length).trim();return""}},{name:"brandimage",elementSelector:selectors.searchPage.sponsoredProducts.brandimage,attribute:selectors.attributes.title,validate:function(e){return endsWithYear(e)?"":e}},{name:"name",elementSelector:selectors.searchPage.sponsoredProducts.productName,attribute:selectors.attributes.dataAttribute,dataShape:function(e){return e.replace(/\\([\s\S])|(")/g,"\\$1$2")}},{name:"altName",elementSelector:selectors.searchPage.sponsoredProducts.altProductName},{name:"price",elementSelector:selectors.searchPage.sponsoredProducts.price,dataShape:function(e){if(e.split(" ").length>0&&e.includes("$")&&!e.includes("."))return e.split(" ")[0]+e.split(" ")[1]+"."+e.split(" ")[2];if(isNumber((e=e.replace(/(\s)|[\-]\K(\W+)/g,"")).charAt(0))&&!e.endsWith("€")){return e.replace(/(\d+([,]+\d+)?([.]\d+)?)/g,"₹$1")}return e},validate:function(e){return/(\$|CDN\$|\£)\w+([\.]\w+)?(\-(\$|CDN\$|\£)\w+([\.]\w+)?)?/.test(e)||/(\₹|EUR|\￥)?\w+(\,]\w+)?(\-(\₹|EUR|\￥)\w+([\,]\w+)?)?(\€)?/.test(e)?e:""}},{name:"rate",elementSelector:selectors.searchPage.sponsoredProducts.rate,dataShape:function(e){var t;return(t=(e=e.trim()).includes("つ星のうち")?e.split(" ")[1]:e.split(" ")[0]).includes(",")?t.replace(/\,/g,"."):t},nonValue:"No rate",validate:function(e){return isNumber(e)||-1!=e.search(/\d\,\d/g)?e:""}},{name:"numberOfReviews",elementSelector:selectors.searchPage.sponsoredProducts.ratings,dataShape:function(e){return e.replace(/\,|\./g,"").trim()},nonValue:"0",validate:function(e){return isNumber(e)?e:""}},{name:"mainimage",elementSelector:selectors.searchPage.sponsoredProducts.image,attribute:selectors.attributes.src},{name:"coupon",elementSelector:selectors.searchPage.sponsoredProducts.coupon,dataShape:function(e){return e.match(/(\d+(\.\d+)?(\%)?)/)[0]},nonValue:"None"},{name:"position",attribute:selectors.attributes.id,dataShape:function(e){return e.substring("_result".length)}},{name:"altPosition",attribute:selectors.attributes.dataIndex,validate:function(e){return isNumber(e)?e:""}}];function crawlSearchPage(e,t){var r={marketplace:e,referral:t,sponsoredProducts:[],sponsoredBrand:{products:[]}};if(r.keyword=document.getElementById(selectors.searchPage.keyword).value,isDefinedAndNotEmpty(r.keyword)){var a=document.querySelectorAll(selectors.searchPage.products);isDefinedAndNotEmpty(a)&&0!=a.length||(document.querySelector(selectors.searchPage.productsWrapper)&&document.querySelector(selectors.searchPage.productsWrapper).hasChildNodes?a=document.querySelector(selectors.searchPage.productsWrapper).childNodes:document.querySelector(selectors.searchPage.altProducts)&&document.querySelector(selectors.searchPage.altProducts).hasChildNodes&&(a=document.querySelector(selectors.searchPage.altProducts).childNodes)),a.forEach(function(e){if("#text"!=e.nodeName&&(e.querySelectorAll(selectors.searchPage.isSponsored)&&e.querySelectorAll(selectors.searchPage.isSponsored).length>0||e.querySelector(selectors.searchPage.isSponsoredCn)&&e.querySelector(selectors.searchPage.isSponsoredCn).innerText&&"Sponsored"==e.querySelector(selectors.searchPage.isSponsoredCn).innerText||e.classList.contains(selectors.searchPage.sponsoredClass))){var t=getProductByVars(sponsoredProductVars,e);isDefinedAndNotEmpty(t.brandimage)&&(t.brand=t.brandimage),delete t.brandimage,isDefinedAndNotEmpty(t.altPosition)&&(t.position=t.altPosition),delete t.altPosition,isDefinedAndNotEmpty(t.altName)&&!isDefinedAndNotEmpty(t.name)&&(t.name=t.altName),delete t.altName,t.asin&&r.sponsoredProducts.push(t)}});var n=document.getElementById(selectors.searchPage.sponsoredBrand.brandName);if(elementHasTextValue(n)){r.sponsoredBrand.name=elementHasTextValue(n);var s=document.querySelector(selectors.searchPage.sponsoredBrand.adImage);elementHasAttributeValue(s,selectors.attributes.src)&&(r.sponsoredBrand.image=elementHasAttributeValue(s,selectors.attributes.src));var o=document.getElementById(selectors.searchPage.sponsoredBrand.headline);elementHasTextValue(o)&&(r.sponsoredBrand.headline=elementHasTextValue(o));var i=document.querySelector(selectors.searchPage.sponsoredBrand.products.blockElement).childNodes;i&&i.length>0&&i.forEach(function(e){var t=getProductByVars(sponsoredBrandProductVars,e);t.asin&&r.sponsoredBrand.products.push(t)})}0!=r.sponsoredBrand.products.length||r.sponsoredBrand.name||(r.sponsoredBrand=void 0),(r.sponsoredBrand&&(r.sponsoredBrand.name||r.sponsoredBrand.products.length>0)||r.sponsoredProducts.length>0)&&sendToBackground(r),initializeBuffer(crawled)}}function crawlProductPage(e,t,r){var a,n,s=extractSubstringFromString(t,"/dp/",["/","?"]),o=document.querySelector(selectors.productPage.ASIN);if(n=isDefinedAndNotEmpty(s)?s:o){var i,l,c=document.getElementById(selectors.productPage.brandName),d=document.querySelector(selectors.productPage.brandNameAlt);if(elementHasTextValue(c))i=c.innerText.trim();else if(elementHasTextValue(d))i=d.innerText.trim();else if(elementHasAttributeValue(d,selectors.attributes.href)){var u=d.getAttribute(selectors.attributes.href);if(i=extractSubstringFromString(u,"/",["/"]),i="s"){var g=extractSubstringFromString(u,"bin=",["?"]);i=g.includes("+")?g.replace("+"," "):g}}isDefinedAndNotEmpty(i)&&i.includes("(Author)")&&(i="");var p,m=document.getElementById("productTitle");elementHasTextValue(m)&&(l=elementHasTextValue(m).trim());var f,h=document.getElementById(selectors.productPage.mainImage),b=document.getElementById(selectors.productPage.comparisonImage);if(elementHasAttributeValue(h,selectors.attributes.src)){var S=elementHasAttributeValue(h,selectors.attributes.src);S.trim().startsWith("data")?h&&h.hasAttribute(selectors.attributes.dataADynamicImage)&&JSON.parse(h.getAttribute(selectors.attributes.dataADynamicImage))&&Object.keys(JSON.parse(h.getAttribute(selectors.attributes.dataADynamicImage))).length?p=Object.keys(JSON.parse(h.getAttribute(selectors.attributes.dataADynamicImage)))[0]:elementHasAttributeValue(b,selectors.attributes.src)&&(p=b.getAttribute(selectors.attributes.src)):p=S}var P,y=document.querySelector(selectors.productPage.price),v=document.querySelector(selectors.productPage.priceAlt),w=document.querySelector(selectors.productPage.priceDeal),A=document.querySelector(selectors.productPage.priceSale);f=(f=(f=elementHasTextValue(w)?w.innerText:elementHasTextValue(y)?elementHasTextValue(y):elementHasTextValue(v)?elementHasTextValue(v):elementHasTextValue(w)?elementHasTextValue(w):elementHasTextValue(A)?elementHasTextValue(A):"").trim()).replace(/(\s)|[\-]\K(\W+)/g,"");var x,T,B=document.getElementById(selectors.productPage.coupon);if(elementHasAttributeValue(B)){var N=B.innerText,V=N.indexOf("%"),D=N.indexOf("$");if(-1!=V)P=N.substring(V-2).split(" ")[0];else if(-1!=D){P=N.substring(D,D+5).trim()}}else P="None";var q=document.querySelector(selectors.productPage.numOfRates);if(elementHasTextValue(q)&&q.innerText.match(/\d|\d+/g)){T=q.innerText.replace(/,/g,"").match(/(\d+)/)[0];var E=document.querySelector(selectors.productPage.rate);if(T&&elementHasTextValue(E)){var H=/(\d+[\.]?[\d+]?)/g;x=E.innerText.includes("つ星のうち")&&E.innerText.match(H)?E.innerText.match(H)[1]:E.innerText.match(H)?E.innerText.match(H)[0]:"No rate"}else x="No rate",T="0"}else x="No rate",T="0";if(i||l||p||f||"None"!=P||"No rate"!=x||0!=T){var I,O,C=[];if(document.querySelector(selectors.productPage.relatedSponsored.detailOne)&&document.querySelector(selectors.productPage.relatedSponsored.detailOne).querySelector(selectors.productPage.relatedSponsored.carousel).children&&(I=document.querySelector(selectors.productPage.relatedSponsored.detailOne).querySelector(selectors.productPage.relatedSponsored.carousel).children),I&&I.length>0)for(j=0;j<I.length;j++){(U=getProductByVars(relatedProductVars,I[j])).asin&&C.push(U)}if(document.querySelector(selectors.productPage.relatedSponsored.detailTwo)&&document.querySelector(selectors.productPage.relatedSponsored.detailTwo).querySelector(selectors.productPage.relatedSponsored.carousel).children&&(O=document.querySelector(selectors.productPage.relatedSponsored.detailTwo).querySelector(selectors.productPage.relatedSponsored.carousel).children),O&&O.length>0)for(k=0;k<O.length;k++){var U;(U=getProductByVars(relatedProductVars,O[k])).asin&&C.push(U)}(a={marketplace:e,asin:n,name:l,brand:i,mainimage:p,rate:x,numberOfReviews:T,price:f,relatedProducts:removeArrayDupes(C,"asin"),coupon:P}).asin&&sendToBackground(a),initializeBuffer(crawled)}}}function crawlDOM(e){isDefinedAndNotEmpty(currentUrl)||(currentUrl=window.location.href);var t=currentUrl.toString().includes(selectors.productPage.url),r=getMarketplace(currentUrl);isSearchPage(currentUrl)?crawlSearchPage(r,e):t&&crawlProductPage(r,currentUrl)}function msgBackgroundBeforeCrawl(e){chrome.runtime.sendMessage({content:e},function(e){"initialize"!=e||crawling.flag||(initializeBuffer(crawling),crawlDOM())})}chrome.runtime.onMessage.addListener(function(e,t,r){"transitionCrawl"!=e.background||crawling.flag||crawled.flag||(initializeBuffer(crawling),crawlDOM())}),msgBackgroundBeforeCrawl("loaded");